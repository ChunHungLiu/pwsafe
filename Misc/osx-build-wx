#!/bin/sh
#
# This script is used to build wxWidgets on Mac OS X in a way that pwsafe 
# will run on as many MacOS versions as possible when built on that machine.
# That also means the wxWidgets build generated by this script would depend
# on the compilers and SDKs supported on the version of OS X it is running on.
# 
# If was initially written for building wx2.8 on Snow Leopard such that the 
# pwsafe binary would run on OS X 10.4+.  It followed the documenetation here:
#   http://wiki.wxwidgets.org/Development:_wxMac
#
# See the sections "Building on Snow Leopard for Snow Leopard" and
# "Building on Snow Leopard for Snow Leopard"
#
# It supports these options, currently
#   -d : Create the Debug build.  Absence of this flag creates the Release build
#   -c <path to wxWidgets' "configure" script : In absence of this, the script is assumed to be in the parent dir
#   -t : The toolkit to be used, either "carbon" or "cocoa".  wx2.8 only supports carbon.  Is selected appropriately if unspecified
#   -n : Dry run.  Will just echo the command(s) to be used to build wxWidgets
#

DEBUG_FLAG=--disable-debug
CONF_SCRIPT=../configure
TOOLKIT=undefined
DRY_RUN=

error() {
	echo "$*" 1>&2
	exit 1
}

while getopts "dc:t:n" opt; do
	case $opt in
		d)
			DEBUG_FLAG=--enable-debug
			;;
		c)
			if [ -x $OPTARG ]
			then
				CONF_SCRIPT=$OPTARG
			else
				error Missing or non-executable configure script: $OPTARG
			fi
			;;
		t)
			case "$OPTARG" in
				carbon) TOOLKIT=CARBON;;
				cocoa)  TOOLKIT=COCOA;;
				*)      error Unexpected toolkit: $OPTARG. Its either \"carbon\" or \"cocoa\" \(default\) 1>&2
						;;
			esac
			;;	
		n)
			DRY_RUN="echo "
			;;
		?)
			exit 1
			;;
	esac
done

WX_VER=`$CONF_SCRIPT -V | grep 'wxWidgets configure' | cut -d' ' -f3`
if [ "$WX_VER" \< "2.9.0" ]
then
	echo This is wxWidgets 2.8.X \(or earlier\): $WX_VER
	if [ "$TOOLKIT" = "COCOA" ]
	then
		error wxWidgets $WX_VER does not support Cocoa
	fi
	# There is only one way to build wx2.8.  It doesn't require a "toolkit" flag
	$DRY_RUN $CONF_SCRIPT --prefix=`pwd` CC=gcc-4.0 CXX=g++-4.0 LD=g++-4.0 $DEBUG_FLAG --with-macosx-version-min=10.4 --with-macosx-sdk=/Developer/SDKs/MacOSX10.4u.sdk --disable-shared --disable-compat24 --enable-unicode --enable-universal-binary
else
	echo This is wxWidgets 2.9.X \(or later\): $WX_VER
	TOOLKIT_FLAG=--with-osx_cocoa
	if [ "$TOOLKIT" = "CARBON" ]
	then
		TOOLKIT_FLAG=--with-osx_carbon
	fi
	$DRY_RUN $CONF_SCRIPT --prefix=`pwd` $DEBUG_FLAG --with-macosx-version-min=10.5 --with-macosx-sdk=/Developer/SDKs/MacOSX10.5.sdk $TOOLKIT_FLAG --disable-shared --disable-compat24 --enable-unicode --enable-universal-binary
fi


